---
layout: page
title: Linux虚拟机KVM详解
tags: 
 - linux
 - vm
---
Linux的虚拟技术目前有KVM和Xen，Xen是运行在裸机上的虚拟化管理程序（Hypervisor），在Redhat 5及其它的发行版中，KVM已经取代了Xen，故此处不针对Xen展开说明，只细述KVM功能。  

KVM（Kernel-based Virtual Machine）是基于内核的虚拟机技术，由以色列Qumranet公司开发，是一个轻量级的虚拟化管理程序模块，该模块主要来自于Linux内核。KVM运行需要CPU支持虚拟化功能，即支持TV的Intel CPU和支持ADM-V的AMD CPU。此外，KVM需要在x86架构的计算机上才能运行。  

下面主要介绍在命令行模式下配置并启动一个KVM虚拟机：  

注：以下所以操作基于Redhat系统 

#### 与虚拟化相关的程序包

| 程序包| 说明 |
| :---: | :---: |
| qemu-kvm | 主要的KVM程序包 |
| libvirt | 用于管理超级监视程序的libvirtd服务 |
| libvirt-client | 用于管理虚拟机的virsh命令和客户端API |
| virt-install | 创建虚拟机需要的命令行工具 |
| virt-manager | GUI虚拟机管理工具（图形界面） |
| virt-top | 虚拟机统计命令 |
| virt-viewer | 用于连接到虚拟机的图形控制台 |

##### 安装KVM
可以使用`yum install *packagename*`单个安装上面的程序包  
也可以使用安装程序包组的方式安装  
```
# yum group install "Virtualization Host" "Virtualization Client"
```

##### 选择正确的KVM模块  
大多数情况下，只要选择了正确的程序包即可，系统会自动加载合适的内核模块。KVM工作之前，必须加载相关的内核模块。
```
# lsmod | grep kvm
```
如果KVM模块正确载入，会在控制台输出如下信息：  
* Intel  
```
kvm_intel   183621   0
kvm         586948   1  kvm_intel
```
* AMD
```
kvm_amd     59887    0
kvm         261575   kvm_amd
```   
分别对应Intel和AMD的处理器。如果未看到输出信息，请检查CPU是否支持虚拟化功能，如果支持，检查虚拟化功能是否开启。检查方法如下：   
```
# egrep 'svm|vmx' /proc/cpuinfo
```
其中：svm（Secure virtual machine）,是AMD的CPU的虚拟化技术AMD-V，vmx是Intel的CPU虚拟化技术Intel-VT  
检查是否有正常的输出，如果有，表示支持虚拟化功能。此外，还需要在开机时进入BIOS或UEFI菜单进行配置，开启虚拟化。 
载入对应的模块：  
```
# modprobe kvm_intel
``` 
或  
```
# modprobe kvm_amd
```

